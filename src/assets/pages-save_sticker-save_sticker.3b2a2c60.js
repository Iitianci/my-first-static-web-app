import{H as e,J as t,n as o,a as s,g as i,R as l,Q as n,ab as a,M as c,s as r,o as u,c as h,w as d,j as g,b as m,e as _,f as p,d as f,r as x,F as w,h as k,l as v,E as y,t as b,i as j}from"./index-f5cba0e4.js";import{_ as T}from"./tc-banner.8b43f15b.js";import{r as C}from"./uni-app.es.62a9cda9.js";import{_ as I}from"./tm-button.37a1a22f.js";import{_ as S}from"./_plugin-vue_export-helper.1b428a4d.js";import"./tm-carousel.vue_vue_type_script_setup_true_lang.5fe38e15.js";import"./tm-image.vue_vue_type_script_setup_true_lang.e60a99a6.js";import"./tm-sheet.38d3d718.js";import"./useTheme.d1454919.js";import"./tm-text.d010834d.js";import"./tm-icon.ed97db34.js";import"./tm-translate.1353da0c.js";let M=null,z=0;const A=S({data:()=>({openid:"",msg_list:[],msgid:"",down_img_list:[],current_url:"",token:"",cookies:"",preview_img_show:!1,touching:!1,overdue:!0}),onShow(){console.log("onshow")},onHide(){console.log("onhide"),console.log("尚未点击看广告")},async onLoad(o={}){wx.createInterstitialAd&&(M=wx.createInterstitialAd({adUnitId:"adunit-3512a82609f4eec1"}),M.onLoad((()=>{})),M.onError((e=>{})),M.onClose((()=>{}))),console.log("options",o),this.openid=o.openid,z=o.in_time||0;let s=(new Date).getTime();Math.abs(s-z)<3e5&&this.openid?(this.overdue=!1,await this.get_ck(),e({title:"正在下载资源中.."}),await this.get_user_sticker(),setTimeout((()=>{t()}),2e3)):this.overdue=!0,setInterval((()=>{this.touching=!1}),2e3)},computed:{img_style(){let e={filter:"blur(20px)"};return this.touching&&(e={}),e}},methods:{touchcancel(){this.touching=!1},touchmove(){0==this.touching&&(this.touching=!0)},touchend(){console.log("@touchend"),this.touching=!1},touchstart(){console.log("touchstart"),this.touching=!0},show_interstitialAd(){M&&M.show().catch((e=>{console.error(e)}))},to_page(e){o({url:e})},to_save_img(e,t,l){this.msgid=l,this.current_url=t,s("img_list",[t]);let n=Math.floor(10*Math.random()),a=i("global_config")||{},c=n<((null==a?void 0:a.probability)||4)?1:0;console.log("nc:",c);let r={img_type:"office",msgid:this.msgid||"",token:this.token,cookies:this.cookies,current_index:e,need_check_ad_review:!1,need_jump:!0,in_time:z,nc:c};o({url:`/pages/matetial/detail?extraData=${encodeURIComponent(JSON.stringify(r))}`})},async get_user_sticker(){let e=await l({url:"https://ck.office.apijuhe.cn/get_user_sticker",data:{openid:this.openid}});console.log("rq_res",e);let{code:t,msg_list:o}=e.data;0==t?(this.msg_list=o,await this.download_img()):uni.vk.alert("请求出错了")},async get_ck(){let e=await l({url:"https://ck.office.apijuhe.cn/get_ck",data:{}});console.log("rq_res",e);let{code:t,token:o,cookies:s}=e.data;0==t?(this.token=o,this.cookies=s):uni.vk.alert("请求出错了")},async download_img(){for(let e=0;e<this.msg_list.length;e++){let t=`https://mp.weixin.qq.com/cgi-bin/downloadfile?msgid=${this.msg_list[e].id}&token=${this.token}&lang=zh_CN`;n({url:t,header:{Cookie:this.cookies,"Content-Type":"image/jpeg"},success:t=>{200===t.statusCode&&(this.msg_list[e].down_url=t.tempFilePath)},fail:e=>{console.log("err",e)}})}},to_save(e){uni.authorize({scope:"scope.writePhotosAlbum",success:()=>{this.saveImg(e)},complete:()=>{uni.getSetting({success:t=>{t.authSetting["scope.writePhotosAlbum"]||this.opensit(e)}})}})},async saveImg(e){e&&a({filePath:e,success:e=>{console.log("res",e),c({title:"保存成功"})},fail:e=>{console.log("err",e),c({title:"保存失败"})}})},opensit(e){r({content:"是否授权小程序保存图片到相册？",success:t=>{t.confirm?uni.openSetting({success:t=>{console.log(t.authSetting),this.saveImg(e)}}):t.cancel&&r({cancelText:"依然取消",confirmText:"重新授权",content:"很遗憾你点击了取消，这将无法进行保存操作",success:e=>{e.confirm?uni.openSetting({success:e=>{console.log(e.authSetting)}}):e.cancel&&console.log("用户拒绝授权，无法保存图片")}})}})}}},[["render",function(e,t,o,s,i,l){const n=C(k("tc-banner"),T),a=v,c=g,r=C(k("tm-button"),I),S=j;return u(),h(c,{onTouchstart:l.touchstart,onTouchend:l.touchend,onTouchcancel:l.touchcancel,onTouchmove:l.touchmove},{default:d((()=>[m(n),i.openid&&i.overdue?(u(),h(c,{key:0},{default:d((()=>[m(c,{class:"flex flex-row flex-center"},{default:d((()=>[m(a,{class:"text-weight-b text-red text-align-center text-size-xl"},{default:d((()=>[_("你的发送的表情已过期,请重新发送")])),_:1})])),_:1})])),_:1})):p("",!0),i.openid?p("",!0):(u(),h(c,{key:1},{default:d((()=>[m(a,{class:"text-weight-b text-red text-align-center text-size-xl"},{default:d((()=>[_("未找到你发送的表情或已过期")])),_:1})])),_:1})),m(c,{class:"flex flex-row flex-center"},{default:d((()=>[m(r,{label:"查看使用教程",color:"green",width:400,height:80,round:20,onClick:t[0]||(t[0]=e=>l.to_page("/pages/web/web"))})])),_:1}),(u(!0),f(w,null,x(i.msg_list,((t,o)=>(u(),h(c,null,{default:d((()=>[m(c,{class:"flex flex-row flex-center",style:y(l.img_style)},{default:d((()=>[m(S,{src:t.down_url,style:{width:"600rpx"},mode:"widthFix"},null,8,["src"])])),_:2},1032,["style"]),m(c,{class:"felx flex-row flex-center"},{default:d((()=>[m(a,{class:"text-blue text-size-xs mt-20"},{default:d((()=>[_("发送时间: "+b(e.vk.pubfn.timeFormat(t.date_time,"yyyy-MM-dd hh:mm:ss")),1)])),_:2},1024)])),_:2},1024),t.down_url?(u(),h(c,{key:0,class:"flex flex-row flex-center"},{default:d((()=>[m(r,{label:"查看/保存",width:400,height:80,round:20,onClick:e=>l.to_save_img(o,t.down_url,t.id)},null,8,["onClick"])])),_:2},1024)):(u(),h(c,{key:1,class:"flex flex-row flex-center"},{default:d((()=>[m(r,{label:"等待加载中",width:400,color:"grey",height:80,round:20})])),_:1}))])),_:2},1024)))),256))])),_:1},8,["onTouchstart","onTouchend","onTouchcancel","onTouchmove"])}]]);export{A as default};
