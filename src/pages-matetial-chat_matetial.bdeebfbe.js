import{q as e,u as a,v as l,ai as t,z as u,A as i,L as o,o as s,c as n,w as r,b as v,e as c,f as h,E as d,G as p,D as m,a5 as x,a6 as g,M as f,N as _,l as y,j as w,O as b,i as k,g as $,S as C,n as I,H as j,Q as M,ak as E,J as T,h as z}from"./index-f5cba0e4.js";import{_ as H}from"./tm-button.37a1a22f.js";import{r as X}from"./uni-app.es.62a9cda9.js";import{t as Y}from"./tm-text.d010834d.js";import{_ as F}from"./_plugin-vue_export-helper.1b428a4d.js";import{c as L,a as N,b as W}from"./check_user_info.62ff098e.js";import"./tm-icon.ed97db34.js";const q=F(e({__name:"tm-cropimg",props:{url:{type:String,default:""},width:{type:Number,default:250},height:{type:Number,default:250}},emits:["confirm","cance"],setup(e,{emit:$}){var C;const I=e,j=(null==(C=a())?void 0:C.proxy)??null,M=l(I.url),{safeArea:E,windowWidth:T,windowHeight:z,statusBarHeight:H}=t(),X=(null==E?void 0:E.width)||T;let F=(null==E?void 0:E.height)??z-44;const L=l({px:0,py:0,px2:0,py2:0,xy:0}),N=l({w:I.width,h:I.height,x:0,y:0}),W=l({scale:1,oldscale:1,center:[0,0],sourceImgWidth:0,sourceImgHeight:0,w:0,h:0,x:0,y:0});let q=l(!1),A=0,P=l(!1),S=null;function B(e){if(!M.value)return;q.value=!0;let a=e.touches[0],l=e.touches[1];"mousedown"==e.type&&(a=e),A=function(e,a){if(e>=N.value.x-15&&e<=N.value.x+15&&a>=N.value.y&&a<=N.value.y+N.value.h)return 1;if(e>=N.value.x&&e<=N.value.w&&a>=N.value.y-15&&a<=N.value.y+15)return 1;if(e>=N.value.x+N.value.w-15&&e<=N.value.x+N.value.w+15&&a>=N.value.y&&a<=N.value.y+N.value.h)return 1;if(e>=N.value.x&&e<=N.value.x+N.value.w&&a>=N.value.y+N.value.h-15&&a<=N.value.y+N.value.h+15)return 1;return 0}(a.pageX,a.pageY),0==A?(L.value.px=a.pageX-W.value.x,L.value.py=a.pageY-W.value.y):(L.value.px=a.pageX-N.value.x,L.value.py=a.pageY-N.value.y),l&&(L.value.px2=l.pageX,L.value.py2=l.pageY),W.value.oldscale=W.value.scale}function J(e){if(!M.value)return;let a=e.touches[0];e.touches[1],"mousedown"==e.type&&(a=e),q.value&&(0==A?(W.value.x=a.pageX-L.value.px,W.value.y=a.pageY-L.value.py):(N.value.x=a.pageX-L.value.px,N.value.y=a.pageY-L.value.py))}function Q(e){M.value&&(q.value=!1,P.value=!1,N.value.x<=12&&(N.value.x=12),N.value.x>=X-N.value.w-12&&(N.value.x=X-N.value.w-12),N.value.y<=12&&(N.value.y=12),N.value.y>=F-N.value.h-90&&(N.value.y=F-N.value.h-90),W.value.x>=N.value.x&&(W.value.x=N.value.x),W.value.x+W.value.w<=N.value.x+N.value.w&&(W.value.x=N.value.x-(W.value.w-N.value.w)),W.value.y>=N.value.y&&(W.value.y=N.value.y),W.value.y+W.value.h<=N.value.y+N.value.h&&(W.value.y=N.value.y-(W.value.h-N.value.h)))}function D(){g({count:1,success(e){let a=e.tempFilePaths;1==a.length&&(M.value=a[0],W.value.scale=1,W.value.oldscale=1)}})}function G(e){const{width:a,height:l}=e.detail;W.value.sourceImgWidth=a,W.value.sourceImgHeight=l,function(){W.value.x=N.value.x;let e=N.value.w,a=e/(W.value.sourceImgWidth/W.value.sourceImgHeight);W.value.h=a,W.value.w=e,W.value.h<N.value.h&&(W.value.h=N.value.h,W.value.w=W.value.h*(e/a));W.value.y=-(W.value.h-N.value.h)/2+N.value.y,W.value.center=[W.value.w/2,W.value.h/2]}()}function K(e){console.log(e)}function O(){if(!M.value)return void f({title:"未选择",icon:"none"});let e=Math.abs(W.value.x-N.value.x),a=Math.abs(W.value.y-N.value.y);S.drawImage(M.value,-e,-a,W.value.w,W.value.h),S.draw(!1,(e=>{_({canvasId:"imgid",success(e){console.log("绘制成功 "),$("confirm",e.tempFilePath)},fail(e){f({title:"裁切失败",icon:"error",mask:!0})}},j)}))}return u((()=>{i((function(){setTimeout((function(){S=o("imgid",j)}),50)}))})),function(){let e=(X-N.value.w)/2,a=(F-N.value.h)/2;N.value.x=e,N.value.y=a}(),(e,a)=>{const l=y,t=w,u=b,i=k;return s(),n(t,{onLongpress:a[1]||(a[1]=()=>{}),onTouchstart:B,onTouchmove:x(J,["stop","prevent"]),onTouchend:Q,onTouchcancel:Q,onMousedown:B,onMousemove:x(J,["stop","prevent"]),onMouseup:Q,onMouseleave:Q,class:"relative overflow",style:d([{width:`${m(X)}px`,height:`${m(F)}px`,background:"#000000"}])},{default:r((()=>[M.value?h("",!0):(s(),n(t,{key:0,class:"flex flex-center py-24"},{default:r((()=>[v(l,{style:{"font-size":"24rpx",color:"white"}},{default:r((()=>[c("请先选择图片")])),_:1})])),_:1})),v(u,{id:"imgid","canvas-id":"imgid",class:"l-0 t-0",style:d([{width:`${N.value.w}px`,height:`${N.value.h}px`,transform:"translate(-1000px,-1000px)"}])},null,8,["style"]),M.value?(s(),n(i,{key:1,onError:K,class:"absolute l-0 t-0",userInteractionEnabled:!1,onLoad:G,src:M.value,style:d([{width:`${W.value.w||1}px`,height:`${W.value.h||1}px`,transform:M.value?`translate(${W.value.x}px,${W.value.y}px) scale(${W.value.scale},${W.value.scale})`:"translate(-1000px,-1000px)","transform-origin":`${W.value.center[0]}px ${W.value.center[1]}px`}])},null,8,["src","style"])):h("",!0),v(t,{class:p([[m(q)?"":"ani"],"absolute l-0 t-0 rect"]),userInteractionEnabled:!1,style:d([{width:N.value.w+"px",height:N.value.h+"px",transform:`translate(${N.value.x}px,${N.value.y}px)`}])},null,8,["class","style"]),v(t,{class:"absolute l-0 b-0 zIndex-2 black",style:d({width:`${m(X)}px`,height:"80px"})},{default:r((()=>[v(t,{class:"flex-row flex flex-row-center-between"},{default:r((()=>[v(t,{onClick:a[0]||(a[0]=e=>$("cance")),class:"flex-1 flex flex-center"},{default:r((()=>[v(Y,{userInteractionEnabled:!1,color:"white",label:"取消"})])),_:1}),v(t,{onClick:D,class:"flex-1 flex flex-center"},{default:r((()=>[v(Y,{userInteractionEnabled:!1,color:"white",label:"选择图片"})])),_:1}),v(t,{onClick:O,class:"flex-1 flex flex-center"},{default:r((()=>[v(Y,{userInteractionEnabled:!1,color:"white",label:"确认"})])),_:1})])),_:1})])),_:1},8,["style"])])),_:1},8,["onTouchmove","onMousemove","style"])}}}),[["__scopeId","data-v-3bae3e0f"]]);const A=F({mixins:[L,N,W],data:()=>({edit_img_show:!1,edit_img_path:"",chat_material:{},openid:"",msg_list:[],down_img_list:[],current_url:"",msgid:"",token:"",img_type:"",cookies:"",in_time:0,preview_img_show:!1,touching:!1}),onShow(){},async onLoad(e={}){this.chat_material=$("chat_material"),console.log("chat_material",this.chat_material),this.chat_material},methods:{restore_img(){this.edit_img_path=""},edit_after_img(e){console.log("path",e),this.edit_img_path=e,this.edit_img_show=!1},to_edit_img(){this.edit_img_show=!0},to_preview_img(){C({urls:[this.current_url]})},to_page(e){I({url:e})},async download_img(){console.log("下载图片中");let e="";e="office_sticker"==this.img_type?`https://mp.weixin.qq.com/cgi-bin/downloadfile?msgid=${this.msgid}&token=${this.token}&lang=zh_CN`:this.current_url,j({title:"正在下载中..",mask:!0}),M({url:e,header:{Cookie:this.cookies,"Content-Type":"image/jpeg"},success:e=>{console.log("下载res",e),200===e.statusCode&&(console.log("下载成功"),this.current_url=e.tempFilePath,E(this.current_url,[this.current_url],!1))},fail:e=>{console.log("err",e)},complete:()=>{T()}})},to_save(){let e=this.edit_img_path||this.chat_material.path;E(e,[e],!0)}}},[["render",function(e,a,l,t,u,i){const o=k,c=w,d=X(z("tm-button"),H),p=X(z("tm-cropimg"),q);return s(),n(c,null,{default:r((()=>[u.chat_material?(s(),n(c,{key:0},{default:r((()=>{var e,a;return[(null==(a=null==(e=u.chat_material)?void 0:e.type)?void 0:a.match(/image/g))?(s(),n(c,{key:0,class:"flex flex-row flex-center"},{default:r((()=>{var e;return[v(o,{src:u.edit_img_path||(null==(e=u.chat_material)?void 0:e.path),style:{width:"700rpx"},mode:"widthFix"},null,8,["src"])]})),_:1})):h("",!0)]})),_:1})):h("",!0),v(c,null,{default:r((()=>[v(c,{class:"flex flex-row flex-around fixed b-n20",style:{width:"750rpx"}},{default:r((()=>[v(d,{label:"裁剪图片",width:200,height:80,round:20,onClick:i.to_edit_img},null,8,["onClick"]),v(d,{label:"保存到相册",color:"green",width:300,height:80,round:20,onClick:i.to_save},null,8,["onClick"]),v(d,{label:"还原图片",width:200,height:80,round:20,onClick:i.restore_img},null,8,["onClick"])])),_:1})])),_:1}),u.edit_img_show?(s(),n(c,{key:1,class:"fixed zIndex-20 t-0 r-0"},{default:r((()=>{var e;return[v(p,{url:null==(e=u.chat_material)?void 0:e.path,onConfirm:i.edit_after_img,onCance:a[0]||(a[0]=e=>u.edit_img_show=!1)},null,8,["url","onConfirm"])]})),_:1})):h("",!0)])),_:1})}]]);export{A as default};
